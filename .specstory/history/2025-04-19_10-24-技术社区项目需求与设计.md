<!-- Generated by SpecStory -->

# 技术社区项目需求与设计 (2025-04-19 18:24:02)

_**User**_

请帮我生成一个技术社区项目，以下是详细需求：

网站风格参考“煎蛋”（https://jandan.net/）和“掘金”（https://juejin.cn/）
网站的功能包含“技术文章”和“问答”（不需要视频教程功能）
网站具备用户登录和注册功能
其中技术文章功能，文章内容具备版本控制功能（文章记录所有修改版本，只显示最新版本，要记录每一个版本的修改人）
网站用户分为两种角色：普通用户，编辑；其中编辑可以编辑网站里面的各项内容，审核技术文章；用户只能增删改查自己发布的内容
网站有搜索内容的功能
网站的技术架构使用next.js+mongdodb实现（请帮我实现从后端数据库设计到前端页面的所有功能设计）
帮我生成一些样例数据


---

_**Assistant**_

我会帮你创建一个完整的技术社区项目。让我们一步一步来实现这个项目。

首先，我们需要创建项目的基本结构和必要的配置文件。我会使用 Next.js 13+ 的 App Router 和 MongoDB 来构建这个项目。

让我们先创建项目的基本结构：

---

```bash
npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"
```

```
ERROR: npm v11.2.0 is known not to run on Node.js v14.21.3.  This version of npm
 supports the following node
 versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://no
dejs.org/.                  
ERROR:
/Users/weli/.nvm/versions/node/v14.21.3/lib/node_modules/npm/lib/utils/error-mes
sage.js:11
  er.message &&= replaceInfo(er.message)
             ^^^

SyntaxError: Unexpected token '&&='
    at wrapSafe (internal/modules/cjs/loader.js:1029:16)
    at Module._compile (internal/modules/cjs/loader.js:1078:27)
    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1143:10)
    at Module.load (internal/modules/cjs/loader.js:979:32)
    at Function.Module._load (internal/modules/cjs/loader.js:819:12)
    at Module.require (internal/modules/cjs/loader.js:1003:19)
    at require (internal/modules/cjs/helpers.js:107:18)
    at Object.<anonymous> (/Users/weli/.nvm/versions/node/v14.21.3/lib/node_modu
les/npm/lib/cli/exit-handler
.js:2:48)
                                at Module._compile (internal/modules/cjs/loader.
js:1114:14)
    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1143:10)

```

---

看起来系统的 Node.js 版本过低，我们需要先更新 Node.js 版本。让我们使用 nvm 来安装并使用最新的 LTS 版本：

---

```bash
nvm install --lts && nvm use --lts
```

```
❯ nvm install --lts && nvm use --lts                                                                18:26:25
Installing latest LTS version.
v22.14.0 is already installed.
Now using node v22.14.0 (npm v11.2.0)
Now using node v22.14.0 (npm v11.2.0)
weli@mini ~/works/tech-blog (master) 
❯                                                                                                   18:26:33
```

---

现在让我们重新创建项目：

---

```bash
npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"
```

```
weli@mini ~/works/tech-blog (master) 
❯ npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"18:26:37
Need to install the following packages:
create-next-app@15.3.1
Ok to proceed? (y) y

The directory tech-blog contains files that could conflict:

  .cursorindexingignore
  .specstory/

Either try using a new directory name, or remove the files listed above.

npm notice
npm notice New minor version of npm available! 11.2.0 -> 11.3.0
npm notice Changelog: https://github.com/npm/cli/releases/tag/v11.3.0
npm notice To update run: npm install -g npm@11.3.0
npm notice
weli@mini ~/works/tech-blog (master) [1]
❯                                                                                                   18:26:53
```

---

看来当前目录已经有一些文件了。让我们先创建一个新的目录：

---

```bash
cd .. && mkdir tech-blog-new && cd tech-blog-new && npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"
```

```
❯ cd .. && mkdir tech-blog-new && cd tech-blog-new && npx create-next-app@latest . --typescript --tailwind -
-eslint --app --src-dir --import-alias
                                                                                                --tailwind -
-eslint --app --src-dir --import-alias
                                       "@/*"
weli@mini ~/works/tech-blog (master) [1]
❯ cd .. && mkdir tech-blog-new && cd tech-blog-new && npx create-next-app@latest . --typescript --tailwind -
-eslint --app --src-dir --import-alias "@/*"
                                       "@/*"

✔ Would you like to use Turbopack for `next dev`? … No / Yes
Creating a new Next.js app in /Users/weli/works/tech-blog-new.

Using npm.

Initializing project with template: app-tw 


Installing dependencies:
- react
- react-dom
- next

Installing devDependencies:
- typescript
- @types/node
- @types/react
- @types/react-dom
- @tailwindcss/postcss
- tailwindcss
- eslint
- eslint-config-next
- @eslint/eslintrc


added 320 packages in 32s

131 packages are looking for funding
  run `npm fund` for details
Initialized a git repository.

Success! Created tech-blog-new at /Users/weli/works/tech-blog-new

weli@mini ~/works/tech-blog-new (main) 
❯                                                                                                   18:28:08
```

---

现在让我们安装一些必要的依赖：

---

```bash
npm install mongoose bcryptjs jsonwebtoken next-auth @headlessui/react @heroicons/react date-fns marked dompurify jsdom @uiw/react-md-editor
```

```
❯ npm install mongoose bcryptjs jsonwebtoken next-auth @headlessui/react @heroicons/react date-fns marked do
mpurify jsdom @uiw/react-md-editor
                                                                                                   marked do
        jsdom @uiw/react-md-editor


added 245 packages in 15s

267 packages are looking for funding
  run `npm fund` for details
weli@mini ~/works/tech-blog-new (main) 
❯                                                                                                   18:28:28
```

---

让我们开始创建项目的基本结构。首先，我们需要创建必要的目录和配置文件：

---

```bash
mkdir -p src/app/api src/components src/lib src/models src/types src/utils src/app/(auth) src/app/(main)
```

```
❯ mkdir -p src/app/api src/components src/lib src/models src/types src/utils src/app/(auth) src/app/(main)
fish: Unknown command: auth
in command substitution
fish: Unknown command
mkdir -p src/app/api src/components src/lib src/models src/types src/utils src/app/(auth) src/app/(main)
                                                                                   ^~~~~^
weli@mini ~/works/tech-blog-new (main) [127]
❯                                                                                                   18:28:35
```

---

抱歉，让我们修改命令以适应 fish shell：

---

```bash
mkdir -p src/app/api src/components src/lib src/models src/types src/utils "src/app/(auth)" "src/app/(main)"
```

```
❯ mkdir -p src/app/api src/components src/lib src/models src/types src/utils "src/app/(auth)" "src/app/(main
)"
                                                                                              "src/app/(main
)"
```

---

现在让我们开始创建项目的核心文件。首先，我们需要设置 MongoDB 连接和环境变量：

---

```diff
- 
+ MONGODB_URI=mongodb://localhost:27017/tech_blog
+ NEXTAUTH_SECRET=your-secret-key-here
+ NEXTAUTH_URL=http://localhost:3000 
```

---

接下来，让我们创建 MongoDB 连接配置：

---

```diff
- 
+ import mongoose from 'mongoose';
+ 
+ const MONGODB_URI = process.env.MONGODB_URI!;
+ 
+ if (!MONGODB_URI) {
+   throw new Error('Please define the MONGODB_URI environment variable inside .env');
+ }
+ 
+ let cached = global.mongoose;
+ 
+ if (!cached) {
+   cached = global.mongoose = { conn: null, promise: null };
+ }
+ 
+ async function connectDB() {
+   if (cached.conn) {
+     return cached.conn;
+   }
+ 
+   if (!cached.promise) {
+     const opts = {
+       bufferCommands: false,
+     };
+ 
+     cached.promise = mongoose.connect(MONGODB_URI, opts).then((mongoose) => {
+       return mongoose;
+     });
+   }
+ 
+   try {
+     cached.conn = await cached.promise;
+   } catch (e) {
+     cached.promise = null;
+     throw e;
+   }
+ 
+   return cached.conn;
+ }
+ 
+ export default connectDB; 
```

---

让我们修复这些 TypeScript 错误：

---

```diff
  import mongoose from 'mongoose';
+ 
+ declare global {
+   var mongoose: {
+     conn: typeof mongoose | null;
+     promise: Promise<typeof mongoose> | null;
+   };
+ }
  
  const MONGODB_URI = process.env.MONGODB_URI!;
```

---

我们需要安装一些类型定义：

---

```bash
npm install --save-dev @types/mongoose
```

```
❯ npm install --save-dev @types/mongoose                                                            18:28:42

added 1 package in 2s

267 packages are looking for funding
  run `npm fund` for details
weli@mini ~/works/tech-blog-new (main) 
❯                                                                                                   18:29:11
```

---

现在让我们创建用户模型：

---

```diff
- 
+ import mongoose from 'mongoose';
+ import bcrypt from 'bcryptjs';
+ 
+ export interface IUser extends mongoose.Document {
+   username: string;
+   email: string;
+   password: string;
+   role: 'user' | 'editor';
+   createdAt: Date;
+   updatedAt: Date;
+   comparePassword(candidatePassword: string): Promise<boolean>;
+ }
+ 
+ const userSchema = new mongoose.Schema<IUser>(
+   {
+     username: {
+       type: String,
+       required: [true, 'Please provide a username'],
+       unique: true,
+       trim: true,
+       minlength: [3, 'Username must be at least 3 characters long'],
+     },
+     email: {
+       type: String,
+       required: [true, 'Please provide an email'],
+       unique: true,
+       trim: true,
+       lowercase: true,
+     },
+     password: {
+       type: String,
+       required: [true, 'Please provide a password'],
+       minlength: [6, 'Password must be at least 6 characters long'],
+     },
+     role: {
+       type: String,
+       enum: ['user', 'editor'],
+       default: 'user',
+     },
+   },
+   {
+     timestamps: true,
+   }
+ );
+ 
+ // Hash password before saving
+ userSchema.pre('save', async function (next) {
+   if (!this.isModified('password')) {
+     return next();
+   }
+   const salt = await bcrypt.genSalt(10);
+   this.password = await bcrypt.hash(this.password, salt);
+   next();
+ });
+ 
+ // Compare password method
+ userSchema.methods.comparePassword = async function (candidatePassword: string) {
+   return bcrypt.compare(candidatePassword, this.password);
+ };
+ 
+ export default mongoose.models.User || mongoose.model<IUser>('User', userSchema); 
```

---

让我们安装 bcryptjs 的类型定义：

---

```bash
npm install --save-dev @types/bcryptjs
```

```
❯ npm install --save-dev @types/bcryptjs                                                            18:29:12

added 1 package in 2s

267 packages are looking for funding
  run `npm fund` for details
weli@mini ~/works/tech-blog-new (main) 
❯                                                                                                   18:29:33
```

---

现在让我们创建文章模型，包含版本控制功能：

---

```diff
- 
+ import mongoose from 'mongoose';
+ import { IUser } from './User';
+ 
+ interface IArticleVersion {
+   content: string;
+   editor: mongoose.Types.ObjectId | IUser;
+   editedAt: Date;
+   changeDescription?: string;
+ }
+ 
+ export interface IArticle extends mongoose.Document {
+   title: string;
+   content: string;
+   author: mongoose.Types.ObjectId | IUser;
+   tags: string[];
+   status: 'draft' | 'published' | 'pending_review';
+   versions: IArticleVersion[];
+   currentVersion: number;
+   createdAt: Date;
+   updatedAt: Date;
+ }
+ 
+ const articleVersionSchema = new mongoose.Schema<IArticleVersion>({
+   content: {
+     type: String,
+     required: true,
+   },
+   editor: {
+     type: mongoose.Schema.Types.ObjectId,
+     ref: 'User',
+     required: true,
+   },
+   editedAt: {
+     type: Date,
+     default: Date.now,
+   },
+   changeDescription: {
+     type: String,
+   },
+ });
+ 
+ const articleSchema = new mongoose.Schema<IArticle>(
+   {
+     title: {
+       type: String,
+       required: [true, 'Please provide a title'],
+       trim: true,
+       minlength: [3, 'Title must be at least 3 characters long'],
+     },
+     content: {
+       type: String,
+       required: [true, 'Please provide content'],
+     },
+     author: {
+       type: mongoose.Schema.Types.ObjectId,
+       ref: 'User',
+       required: true,
+     },
+     tags: [{
+       type: String,
+       trim: true,
+     }],
+     status: {
+       type: String,
+       enum: ['draft', 'published', 'pending_review'],
+       default: 'draft',
+     },
+     versions: [articleVersionSchema],
+     currentVersion: {
+       type: Number,
+       default: 0,
+     },
+   },
+   {
+     timestamps: true,
+   }
+ );
+ 
+ // 创建新版本的中间件
+ articleSchema.pre('save', function(next) {
+   if (this.isModified('content')) {
+     this.versions.push({
+       content: this.content,
+       editor: this.isNew ? this.author : this.get('editor'),
+       editedAt: new Date(),
+       changeDescription: this.get('changeDescription'),
+     });
+     this.currentVersion = this.versions.length - 1;
+   }
+   next();
+ });
+ 
+ export default mongoose.models.Article || mongoose.model<IArticle>('Article', articleSchema); 
```

---

现在让我们创建问答模型：

---

```diff
- 
+  
```

---

让我们重试一下：

---

```diff
-  
+ import mongoose from 'mongoose';
+ import { IUser } from './User';
+ 
+ interface IAnswer {
+   content: string;
+   author: mongoose.Types.ObjectId | IUser;
+   votes: number;
+   isAccepted: boolean;
+   createdAt: Date;
+   updatedAt: Date;
+ }
+ 
+ export interface IQuestion extends mongoose.Document {
+   title: string;
+   content: string;
+   author: mongoose.Types.ObjectId | IUser;
+   tags: string[];
+   answers: IAnswer[];
+   votes: number;
+   views: number;
+   createdAt: Date;
+   updatedAt: Date;
+ }
+ 
+ const answerSchema = new mongoose.Schema<IAnswer>(
+   {
+     content: {
+       type: String,
+       required: [true, 'Please provide an answer'],
+     },
+     author: {
+       type: mongoose.Schema.Types.ObjectId,
+       ref: 'User',
+       required: true,
+     },
+     votes: {
+       type: Number,
+       default: 0,
+     },
+     isAccepted: {
+       type: Boolean,
+       default: false,
+     },
+   },
+   {
+     timestamps: true,
+   }
+ );
+ 
+ const questionSchema = new mongoose.Schema<IQuestion>(
+   {
+     title: {
+       type: String,
+       required: [true, 'Please provide a title'],
+       trim: true,
+       minlength: [10, 'Title must be at least 10 characters long'],
+     },
+     content: {
+       type: String,
+       required: [true, 'Please provide content'],
+     },
+     author: {
+       type: mongoose.Schema.Types.ObjectId,
+       ref: 'User',
+       required: true,
+     },
+     tags: [{
+       type: String,
+       trim: true,
+     }],
+     answers: [answerSchema],
+     votes: {
+       type: Number,
+       default: 0,
+     },
+     views: {
+       type: Number,
+       default: 0,
+     },
+   },
+   {
+     timestamps: true,
+   }
+ );
+ 
+ export default mongoose.models.Question || mongoose.model<IQuestion>('Question', questionSchema); 
```

---

现在让我们创建认证相关的 API 路由：

---

```diff
- 
+ import NextAuth from 'next-auth';
+ import CredentialsProvider from 'next-auth/providers/credentials';
+ import bcrypt from 'bcryptjs';
+ import connectDB from '@/lib/mongodb';
+ import User from '@/models/User';
+ 
+ const handler = NextAuth({
+   providers: [
+     CredentialsProvider({
+       name: 'Credentials',
+       credentials: {
+         email: { label: "Email", type: "email" },
+         password: { label: "Password", type: "password" }
+       },
+       async authorize(credentials) {
+         if (!credentials?.email || !credentials?.password) {
+           throw new Error('Please enter an email and password');
+         }
+ 
+         await connectDB();
+ 
+         const user = await User.findOne({ email: credentials.email });
+ 
+         if (!user) {
+           throw new Error('No user found with this email');
+         }
+ 
+         const isValid = await user.comparePassword(credentials.password);
+ 
+         if (!isValid) {
+           throw new Error('Invalid password');
+         }
+ 
+         return {
+           id: user._id.toString(),
+           email: user.email,
+           username: user.username,
+           role: user.role,
+         };
+       }
+     })
+   ],
+   session: {
+     strategy: 'jwt',
+   },
+   callbacks: {
+     async jwt({ token, user }) {
+       if (user) {
+         token.role = user.role;
+         token.username = user.username;
+       }
+       return token;
+     },
+     async session({ session, token }) {
+       if (token) {
+         session.user.role = token.role;
+         session.user.username = token.username;
+       }
+       return session;
+     }
+   },
+   pages: {
+     signIn: '/login',
+   },
+ });
+ 
+ export { handler as GET, handler as POST }; 
```

---

让我们安装 next-auth 的类型定义：

---

```bash
npm install --save-dev @types/next-auth
```

```
❯ npm install --save-dev @types/next-auth                                                           18:29:33
npm warn deprecated inflight@1.0.6: This module is not supported, and leaks memory. Do not use it. Check out
 lru-cache if you want a good and tested way to coalesce async requests by a key value, which is much more c
omprehensive and powerful.
npm warn deprecated glob@7.2.3: Glob versions prior to v9 are no longer supported
npm warn deprecated jose@1.28.2: this version is no longer supported

added 66 packages in 6s

274 packages are looking for funding
  run `npm fund` for details
weli@mini ~/works/tech-blog-new (main) 
❯                                                                                                   18:30:32
```

---

现在让我们创建用户注册的 API 路由：

---

```diff
- 
+ import { NextResponse } from 'next/server';
+ import connectDB from '@/lib/mongodb';
+ import User from '@/models/User';
+ 
+ export async function POST(request: Request) {
+   try {
+     const { username, email, password } = await request.json();
+ 
+     if (!username || !email || !password) {
+       return NextResponse.json(
+         { error: 'Missing required fields' },
+         { status: 400 }
+       );
+     }
+ 
+     await connectDB();
+ 
+     // Check if user already exists
+     const existingUser = await User.findOne({
+       $or: [{ email }, { username }],
+     });
+ 
+     if (existingUser) {
+       return NextResponse.json(
+         { error: 'User already exists' },
+         { status: 400 }
+       );
+     }
+ 
+     // Create new user
+     const user = await User.create({
+       username,
+       email,
+       password,
+       role: 'user',
+     });
+ 
+     return NextResponse.json(
+       {
+         user: {
+           id: user._id,
+           username: user.username,
+           email: user.email,
+           role: user.role,
+         },
+       },
+       { status: 201 }
+     );
+   } catch (error: any) {
+     return NextResponse.json(
+       { error: error.message || 'Internal server error' },
+       { status: 500 }
+     );
+   }
+ } 
```

---

现在让我们创建文章相关的 API 路由：

---

```diff
- 
+ import { NextResponse } from 'next/server';
+ import { getServerSession } from 'next-auth';
+ import connectDB from '@/lib/mongodb';
+ import Article from '@/models/Article';
+ 
+ // Get all articles
+ export async function GET(request: Request) {
+   try {
+     const { searchParams } = new URL(request.url);
+     const page = parseInt(searchParams.get('page') || '1');
+     const limit = parseInt(searchParams.get('limit') || '10');
+     const search = searchParams.get('search') || '';
+     const tag = searchParams.get('tag') || '';
+ 
+     await connectDB();
+ 
+     const query: any = { status: 'published' };
+     if (search) {
+       query.$or = [
+         { title: { $regex: search, $options: 'i' } },
+         { content: { $regex: search, $options: 'i' } },
+       ];
+     }
+     if (tag) {
+       query.tags = tag;
+     }
+ 
+     const skip = (page - 1) * limit;
+     const articles = await Article.find(query)
+       .populate('author', 'username')
+       .sort({ createdAt: -1 })
+       .skip(skip)
+       .limit(limit);
+ 
+     const total = await Article.countDocuments(query);
+ 
+     return NextResponse.json({
+       articles,
+       total,
+       totalPages: Math.ceil(total / limit),
+       currentPage: page,
+     });
+   } catch (error: any) {
+     return NextResponse.json(
+       { error: error.message || 'Internal server error' },
+       { status: 500 }
+     );
+   }
+ }
+ 
+ // Create new article
+ export async function POST(request: Request) {
+   try {
+     const session = await getServerSession();
+     if (!session?.user) {
+       return NextResponse.json(
+         { error: 'Unauthorized' },
+         { status: 401 }
+       );
+     }
+ 
+     const { title, content, tags } = await request.json();
+ 
+     if (!title || !content) {
+       return NextResponse.json(
+         { error: 'Missing required fields' },
+         { status: 400 }
+       );
+     }
+ 
+     await connectDB();
+ 
+     const article = await Article.create({
+       title,
+       content,
+       tags: tags || [],
+       author: session.user.id,
+       versions: [{
+         content,
+         editor: session.user.id,
+         editedAt: new Date(),
+         changeDescription: 'Initial version',
+       }],
+     });
+ 
+     return NextResponse.json(article, { status: 201 });
+   } catch (error: any) {
+     return NextResponse.json(
+       { error: error.message || 'Internal server error' },
+       { status: 500 }
+     );
+   }
+ } 
```

---

让我们创建单个文章的 API 路由：

---

```diff
- 
+ import { NextResponse } from 'next/server';
+ import { getServerSession } from 'next-auth';
+ import connectDB from '@/lib/mongodb';
+ import Article from '@/models/Article';
+ 
+ // Get single article
+ export async function GET(
+   request: Request,
+   { params }: { params: { id: string } }
+ ) {
+   try {
+     await connectDB();
+ 
+     const article = await Article.findById(params.id)
+       .populate('author', 'username')
+       .populate('versions.editor', 'username');
+ 
+     if (!article) {
+       return NextResponse.json(
+         { error: 'Article not found' },
+         { status: 404 }
+       );
+     }
+ 
+     return NextResponse.json(article);
+   } catch (error: any) {
+     return NextResponse.json(
+       { error: error.message || 'Internal server error' },
+       { status: 500 }
+     );
+   }
+ }
+ 
+ // Update article
+ export async function PUT(
+   request: Request,
+   { params }: { params: { id: string } }
+ ) {
+   try {
+     const session = await getServerSession();
+     if (!session?.user) {
+       return NextResponse.json(
+         { error: 'Unauthorized' },
+         { status: 401 }
+       );
+     }
+ 
+     const { title, content, tags, changeDescription } = await request.json();
+ 
+     await connectDB();
+ 
+     const article = await Article.findById(params.id);
+ 
+     if (!article) {
+       return NextResponse.json(
+         { error: 'Article not found' },
+         { status: 404 }
+       );
+     }
+ 
+     // Check if user is author or editor
+     if (
+       article.author.toString() !== session.user.id &&
+       session.user.role !== 'editor'
+     ) {
+       return NextResponse.json(
+         { error: 'Unauthorized' },
+         { status: 401 }
+       );
+     }
+ 
+     // Update article
+     if (title) article.title = title;
+     if (content) article.content = content;
+     if (tags) article.tags = tags;
+ 
+     // Add new version if content changed
+     if (content && content !== article.content) {
+       article.versions.push({
+         content,
+         editor: session.user.id,
+         editedAt: new Date(),
+         changeDescription,
+       });
+       article.currentVersion = article.versions.length - 1;
+     }
+ 
+     await article.save();
+ 
+     return NextResponse.json(article);
+   } catch (error: any) {
+     return NextResponse.json(
+       { error: error.message || 'Internal server error' },
+       { status: 500 }
+     );
+   }
+ }
+ 
+ // Delete article
+ export async function DELETE(
+   request: Request,
+   { params }: { params: { id: string } }
+ ) {
+   try {
+     const session = await getServerSession();
+     if (!session?.user) {
+       return NextResponse.json(
+         { error: 'Unauthorized' },
+         { status: 401 }
+       );
+     }
+ 
+     await connectDB();
+ 
+     const article = await Article.findById(params.id);
+ 
+     if (!article) {
+       return NextResponse.json(
+         { error: 'Article not found' },
+         { status: 404 }
+       );
+     }
+ 
+     // Check if user is author or editor
+     if (
+       article.author.toString() !== session.user.id &&
+       session.user.role !== 'editor'
+     ) {
+       return NextResponse.json(
+         { error: 'Unauthorized' },
+         { status: 401 }
+       );
+     }
+ 
+     await article.deleteOne();
+ 
+     return NextResponse.json(
+       { message: 'Article deleted successfully' }
+     );
+   } catch (error: any) {
+     return NextResponse.json(
+       { error: error.message || 'Internal server error' },
+       { status: 500 }
+     );
+   }
+ } 
```

---

让我们创建问答相关的 API 路由：

---

```diff
- 
+ import { NextResponse } from 'next/server';
+ import { getServerSession } from 'next-auth';
+ import connectDB from '@/lib/mongodb';
+ import Question from '@/models/Question';
+ 
+ // Get all questions
+ export async function GET(request: Request) {
+   try {
+     const { searchParams } = new URL(request.url);
+     const page = parseInt(searchParams.get('page') || '1');
+     const limit = parseInt(searchParams.get('limit') || '10');
+     const search = searchParams.get('search') || '';
+     const tag = searchParams.get('tag') || '';
+ 
+     await connectDB();
+ 
+     const query: any = {};
+     if (search) {
+       query.$or = [
+         { title: { $regex: search, $options: 'i' } },
+         { content: { $regex: search, $options: 'i' } },
+       ];
+     }
+     if (tag) {
+       query.tags = tag;
+     }
+ 
+     const skip = (page - 1) * limit;
+     const questions = await Question.find(query)
+       .populate('author', 'username')
+       .populate('answers.author', 'username')
+       .sort({ createdAt: -1 })
+       .skip(skip)
+       .limit(limit);
+ 
+     const total = await Question.countDocuments(query);
+ 
+     return NextResponse.json({
+       questions,
+       total,
+       totalPages: Math.ceil(total / limit),
+       currentPage: page,
+     });
+   } catch (error: any) {
+     return NextResponse.json(
+       { error: error.message || 'Internal server error' },
+       { status: 500 }
+     );
+   }
+ }
+ 
+ // Create new question
+ export async function POST(request: Request) {
+   try {
+     const session = await getServerSession();
+     if (!session?.user) {
+       return NextResponse.json(
+         { error: 'Unauthorized' },
+         { status: 401 }
+       );
+     }
+ 
+     const { title, content, tags } = await request.json();
+ 
+     if (!title || !content) {
+       return NextResponse.json(
+         { error: 'Missing required fields' },
+         { status: 400 }
+       );
+     }
+ 
+     await connectDB();
+ 
+     const question = await Question.create({
+       title,
+       content,
+       tags: tags || [],
+       author: session.user.id,
+     });
+ 
+     return NextResponse.json(question, { status: 201 });
+   } catch (error: any) {
+     return NextResponse.json(
+       { error: error.message || 'Internal server error' },
+       { status: 500 }
+     );
+   }
+ } 
```

---

让我们创建单个问题的 API 路由：

---

```diff
- 
+ import { NextResponse } from 'next/server';
+ import { getServerSession } from 'next-auth';
+ import connectDB from '@/lib/mongodb';
+ import Question from '@/models/Question';
+ 
+ // Get single question
+ export async function GET(
+   request: Request,
+   { params }: { params: { id: string } }
+ ) {
+   try {
+     await connectDB();
+ 
+     const question = await Question.findById(params.id)
+       .populate('author', 'username')
+       .populate('answers.author', 'username');
+ 
+     if (!question) {
+       return NextResponse.json(
+         { error: 'Question not found' },
+         { status: 404 }
+       );
+     }
+ 
+     return NextResponse.json(question);
+   } catch (error: any) {
+     return NextResponse.json(
+       { error: error.message || 'Internal server error' },
+       { status: 500 }
+     );
+   }
+ }
+ 
+ // Update question
+ export async function PUT(
+   request: Request,
+   { params }: { params: { id: string } }
+ ) {
+   try {
+     const session = await getServerSession();
+     if (!session?.user) {
+       return NextResponse.json(
+         { error: 'Unauthorized' },
+         { status: 401 }
+       );
+     }
+ 
+     const { title, content, tags } = await request.json();
+ 
+     await connectDB();
+ 
+     const question = await Question.findById(params.id);
+ 
+     if (!question) {
+       return NextResponse.json(
+         { error: 'Question not found' },
+         { status: 404 }
+       );
+     }
+ 
+     // Check if user is author or editor
+     if (
+       question.author.toString() !== session.user.id &&
+       session.user.role !== 'editor'
+     ) {
+       return NextResponse.json(
+         { error: 'Unauthorized' },
+         { status: 401 }
+       );
+     }
+ 
+     // Update question
+     if (title) question.title = title;
+     if (content) question.content = content;
+     if (tags) question.tags = tags;
+ 
+     await question.save();
+ 
+     return NextResponse.json(question);
+   } catch (error: any) {
+     return NextResponse.json(
+       { error: error.message || 'Internal server error' },
+       { status: 500 }
+     );
+   }
+ }
+ 
+ // Delete question
+ export async function DELETE(
+   request: Request,
+   { params }: { params: { id: string } }
+ ) {
+   try {
+     const session = await getServerSession();
+     if (!session?.user) {
+       return NextResponse.json(
+         { error: 'Unauthorized' },
+         { status: 401 }
+       );
+     }
+ 
+     await connectDB();
+ 
+     const question = await Question.findById(params.id);
+ 
+     if (!question) {
+       return NextResponse.json(
+         { error: 'Question not found' },
+         { status: 404 }
+       );
+     }
+ 
+     // Check if user is author or editor
+     if (
+       question.author.toString() !== session.user.id &&
+       session.user.role !== 'editor'
+     ) {
+       return NextResponse.json(
+         { error: 'Unauthorized' },
+         { status: 401 }
+       );
+     }
+ 
+     await question.deleteOne();
+ 
+     return NextResponse.json(
+       { message: 'Question deleted successfully' }
+     );
+   } catch (error: any) {
+     return NextResponse.json(
+       { error: error.message || 'Internal server error' },
+       { status: 500 }
+     );
+   }
+ } 
```

---

让我们创建问题回答的 API 路由：

---

```diff
- 
+ import { NextResponse } from 'next/server';
+ import { getServerSession } from 'next-auth';
+ import connectDB from '@/lib/mongodb';
+ import Question from '@/models/Question';
+ 
+ // Add answer to question
+ export async function POST(
+   request: Request,
+   { params }: { params: { id: string } }
+ ) {
+   try {
+     const session = await getServerSession();
+     if (!session?.user) {
+       return NextResponse.json(
+         { error: 'Unauthorized' },
+         { status: 401 }
+       );
+     }
+ 
+     const { content } = await request.json();
+ 
+     if (!content) {
+       return NextResponse.json(
+         { error: 'Answer content is required' },
+         { status: 400 }
+       );
+     }
+ 
+     await connectDB();
+ 
+     const question = await Question.findById(params.id);
+ 
+     if (!question) {
+       return NextResponse.json(
+         { error: 'Question not found' },
+         { status: 404 }
+       );
+     }
+ 
+     question.answers.push({
+       content,
+       author: session.user.id,
+       votes: 0,
+       isAccepted: false,
+     });
+ 
+     await question.save();
+ 
+     return NextResponse.json(question, { status: 201 });
+   } catch (error: any) {
+     return NextResponse.json(
+       { error: error.message || 'Internal server error' },
+       { status: 500 }
+     );
+   }
+ } 
```

---

让我们创建前端组件。首先是导航栏组件：

---

```diff
- 
+ import Link from 'next/link';
+ import { useSession, signOut } from 'next-auth/react';
+ import { useState } from 'react';
+ import { Dialog } from '@headlessui/react';
+ import { Bars3Icon, XMarkIcon } from '@heroicons/react/24/outline';
+ 
+ const navigation = [
+   { name: '首页', href: '/' },
+   { name: '技术文章', href: '/articles' },
+   { name: '问答', href: '/questions' },
+ ];
+ 
+ export default function Navbar() {
+   const { data: session } = useSession();
+   const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
+ 
+   return (
+     <header className="bg-white">
+       <nav className="mx-auto flex max-w-7xl items-center justify-between p-6 lg:px-8" aria-label="Global">
+         <div className="flex lg:flex-1">
+           <Link href="/" className="-m-1.5 p-1.5">
+             <span className="text-2xl font-bold">Tech Blog</span>
+           </Link>
+         </div>
+         <div className="flex lg:hidden">
+           <button
+             type="button"
+             className="-m-2.5 inline-flex items-center justify-center rounded-md p-2.5 text-gray-700"
+             onClick={() => setMobileMenuOpen(true)}
+           >
+             <span className="sr-only">Open main menu</span>
+             <Bars3Icon className="h-6 w-6" aria-hidden="true" />
+           </button>
+         </div>
+         <div className="hidden lg:flex lg:gap-x-12">
+           {navigation.map((item) => (
+             <Link
+               key={item.name}
+               href={item.href}
+               className="text-sm font-semibold leading-6 text-gray-900 hover:text-gray-600"
+             >
+               {item.name}
+             </Link>
+           ))}
+         </div>
+         <div className="hidden lg:flex lg:flex-1 lg:justify-end">
+           {session ? (
+             <div className="flex items-center gap-4">
+               <Link
+                 href="/dashboard"
+                 className="text-sm font-semibold leading-6 text-gray-900 hover:text-gray-600"
+               >
+                 仪表盘
+               </Link>
+               <button
+                 onClick={() => signOut()}
+                 className="text-sm font-semibold leading-6 text-gray-900 hover:text-gray-600"
+               >
+                 退出
+               </button>
+             </div>
+           ) : (
+             <Link
+               href="/login"
+               className="text-sm font-semibold leading-6 text-gray-900 hover:text-gray-600"
+             >
+               登录 <span aria-hidden="true">&rarr;</span>
+             </Link>
+           )}
+         </div>
+       </nav>
+       <Dialog as="div" className="lg:hidden" open={mobileMenuOpen} onClose={setMobileMenuOpen}>
+         <div className="fixed inset-0 z-10" />
+         <Dialog.Panel className="fixed inset-y-0 right-0 z-10 w-full overflow-y-auto bg-white px-6 py-6 sm:max-w-sm sm:ring-1 sm:ring-gray-900/10">
+           <div className="flex items-center justify-between">
+             <Link href="/" className="-m-1.5 p-1.5">
+               <span className="text-2xl font-bold">Tech Blog</span>
+             </Link>
+             <button
+               type="button"
+               className="-m-2.5 rounded-md p-2.5 text-gray-700"
+               onClick={() => setMobileMenuOpen(false)}
+             >
+               <span className="sr-only">Close menu</span>
+               <XMarkIcon className="h-6 w-6" aria-hidden="true" />
+             </button>
+           </div>
+           <div className="mt-6 flow-root">
+             <div className="-my-6 divide-y divide-gray-500/10">
+               <div className="space-y-2 py-6">
+                 {navigation.map((item) => (
+                   <Link
+                     key={item.name}
+                     href={item.href}
+                     className="-mx-3 block rounded-lg px-3 py-2 text-base font-semibold leading-7 text-gray-900 hover:bg-gray-50"
+                     onClick={() => setMobileMenuOpen(false)}
+                   >
+                     {item.name}
+                   </Link>
+                 ))}
+               </div>
+               <div className="py-6">
+                 {session ? (
+                   <>
+                     <Link
+                       href="/dashboard"
+                       className="-mx-3 block rounded-lg px-3 py-2.5 text-base font-semibold leading-7 text-gray-900 hover:bg-gray-50"
+                       onClick={() => setMobileMenuOpen(false)}
+                     >
+                       仪表盘
+                     </Link>
+                     <button
+                       onClick={() => {
+                         signOut();
+                         setMobileMenuOpen(false);
+                       }}
+                       className="-mx-3 block rounded-lg px-3 py-2.5 text-base font-semibold leading-7 text-gray-900 hover:bg-gray-50"
+                     >
+                       退出
+                     </button>
+                   </>
+                 ) : (
+                   <Link
+                     href="/login"
+                     className="-mx-3 block rounded-lg px-3 py-2.5 text-base font-semibold leading-7 text-gray-900 hover:bg-gray-50"
+                     onClick={() => setMobileMenuOpen(false)}
+                   >
+                     登录
+                   </Link>
+                 )}
+               </div>
+             </div>
+           </div>
+         </Dialog.Panel>
+       </Dialog>
+     </header>
+   );
+ } 
```

---

让我们创建文章列表组件：

---

```diff
- 
+ import Link from 'next/link';
+ import { format } from 'date-fns';
+ import { IArticle } from '@/models/Article';
+ 
+ interface ArticleListProps {
+   articles: IArticle[];
+ }
+ 
+ export default function ArticleList({ articles }: ArticleListProps) {
+   return (
+     <div className="space-y-8">
+       {articles.map((article) => (
+         <article key={article._id.toString()} className="bg-white p-6 rounded-lg shadow">
+           <Link href={`/articles/${article._id}`}>
+             <h2 className="text-2xl font-bold text-gray-900 hover:text-gray-600">
+               {article.title}
+             </h2>
+           </Link>
+           <div className="mt-2 flex items-center text-sm text-gray-500">
+             <span>作者: {(article.author as any).username}</span>
+             <span className="mx-2">&bull;</span>
+             <time dateTime={article.createdAt.toString()}>
+               {format(new Date(article.createdAt), 'yyyy-MM-dd')}
+             </time>
+           </div>
+           <div className="mt-3 flex flex-wrap gap-2">
+             {article.tags.map((tag) => (
+               <Link
+                 key={tag}
+                 href={`/articles?tag=${tag}`}
+                 className="inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-gray-100 text-gray-800 hover:bg-gray-200"
+               >
+                 {tag}
+               </Link>
+             ))}
+           </div>
+           <p className="mt-3 text-gray-600 line-clamp-3">
+             {article.content}
+           </p>
+           <div className="mt-4">
+             <Link
+               href={`/articles/${article._id}`}
+               className="text-blue-600 hover:text-blue-800 font-medium"
+             >
+               阅读全文 &rarr;
+             </Link>
+           </div>
+         </article>
+       ))}
+     </div>
+   );
+ } 
```

---





---

_**User**_

请将项目移动到当前目录

---

_**Assistant**_

我注意到我们需要将项目从 tech-blog-new 移动到当前目录。让我们执行这个操作：

---

```bash
mv ../tech-blog-new/* . && mv ../tech-blog-new/.* . 2>/dev/null || true
```

```
❯ mv ../tech-blog-new/* . && mv ../tech-blog-new/.* . 2>/dev/null || true                           18:30:32
mv: ../tech-blog-new/eslint.config.mjs and ./eslint.config.mjs are identical
mv: ../tech-blog-new/next-env.d.ts and ./next-env.d.ts are identical
mv: ../tech-blog-new/next.config.ts and ./next.config.ts are identical
mv: ../tech-blog-new/node_modules and ./node_modules are identical
mv: ../tech-blog-new/package-lock.json and ./package-lock.json are identical
mv: ../tech-blog-new/package.json and ./package.json are identical
mv: ../tech-blog-new/postcss.config.mjs and ./postcss.config.mjs are identical
mv: ../tech-blog-new/public and ./public are identical
mv: ../tech-blog-new/README.md and ./README.md are identical
mv: ../tech-blog-new/src and ./src are identical
mv: ../tech-blog-new/tsconfig.json and ./tsconfig.json are identical
weli@mini ~/works/tech-blog-new (main) 
❯                                                                                                   18:33:28
```

---

看起来文件已经存在于当前目录中。让我们检查一下当前目录的结构：

---

<details>
            <summary>Listed current directory • **6** results</summary>
        
| Name |
|-------|
| 📁 `src` |
| 📄 `.env` |
| 📄 `.cursorindexingignore` |
| 📁 `.specstory` |
| 📁 `.git` |
| 📄 `.gitignore` |

</details>

---

让我们检查一下 src 目录的内容：

---

<details>
            <summary>Listed directory src • **4** results</summary>
        
| Name |
|-------|
| 📁 `components` |
| 📁 `app` |
| 📁 `models` |
| 📁 `lib` |

</details>

---

看起来项目的主要文件已经在正确的位置了。现在让我们安装必要的依赖：

---

```bash
npm install next@latest react@latest react-dom@latest next-auth@latest mongoose bcryptjs @headlessui/react @heroicons/react date-fns marked dompurify jsdom @uiw/react-md-editor
```

```
❯ npm install next@latest react@latest react-dom@latest next-auth@latest mongoose bcryptjs @headlessui/react
 @heroicons/react date-fns marked domp
                                                                                                          ct
 @heroicons/react date-fns marked domp
                                      urify jsdom @uiw/react-md-editor
                                            jsdom @uiw/react-md-editor


up to date in 5s

274 packages are looking for funding
  run `npm fund` for details
weli@mini ~/works/tech-blog-new (main) 
❯                                                                                                   18:33:45
```

---

让我们安装开发依赖：

---

```bash
npm install --save-dev typescript @types/react @types/node @types/react-dom @types/bcryptjs @types/mongoose @types/next-auth @types/marked @types/dompurify @types/jsdom autoprefixer postcss tailwindcss
```

```
❯ npm install --save-dev typescript @types/react @types/node @types/react-dom @types/bcryptjs @types/mongoos
e @types/next-auth @types/marked @type
  @types/next-auth @types/marked @type
                                      s/dompurify @types/jsdom autoprefixer postcss tail
                                                  @types/jsdom autoprefixer postcss tail
                                                                                        windcss


added 12 packages in 3s

278 packages are looking for funding
  run `npm fund` for details
weli@mini ~/works/tech-blog-new (main) 
❯                                                                                                   18:33:54
```

---

现在让我们创建一个 package.json 文件：

---

Cancelled

---



---



---

